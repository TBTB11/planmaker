# セキュリティ仕様

運用レベルのセキュリティチェックリストは `docs/handbook/05_development_handbook.md` Part 3 を参照。
本ドキュメントはリスク一覧と**実装レベルのセキュリティ原則**を定義する。

---

## 1. リスク一覧

### 1.1 データ保護

| ID | リスク | 影響 | 対策 |
|----|-------|------|------|
| D-01 | ブラウザ保存データへの不正アクセス | 生徒情報漏洩 | 暗号化保存、端末ロック推奨、センシティブデータ分離 |
| D-02 | JSONエクスポートファイルの流出 | 全データ漏洩 | エクスポート時の暗号化オプション、パスワード保護 |
| D-03 | 共有端末でのデータ漏洩 | 他ユーザーによる閲覧 | セッション終了時の明示的ログアウト、自動クリア機能 |
| D-04 | バックアップ未実施によるデータ消失 | 全データ消失 | 定期的なエクスポート促進、自動バックアップ提案 |
| D-05 | 生徒番号と個人情報の紐づけ管理 | 個人特定 | 本ツール外での厳重管理を運用規定で明記 |

### 1.2 AI補完機能

| ID | リスク | 影響 | 対策 |
|----|-------|------|------|
| A-01 | 外部AI APIへのデータ送信 | 生徒データ外部流出 | ローカルAI優先、送信時は匿名化必須、送信内容の明示 |
| A-02 | AIの誤った補完による判断ミス | 不適切な学習計画 | 信頼度表示、重要判定は必ず確認、AI質問機能 |
| A-03 | 類似生徒パターン利用時のプライバシー | 間接的な個人特定 | 統計データのみ利用、k-匿名性の確保 |
| A-04 | AIコンテキストに機微情報が蓄積 | 学習特性等の漏洩 | コンテキストの暗号化、削除機能の提供 |

### 1.3 Webアプリケーション

| ID | リスク | 影響 | 対策 |
|----|-------|------|------|
| W-01 | XSS | 悪意あるスクリプト実行 | 入力サニタイズ、CSP設定、Reactの自動エスケープ活用 |
| W-02 | CSRF | 意図しない操作実行 | ローカルファーストなら低リスク、API利用時はトークン検証 |
| W-03 | 依存ライブラリの脆弱性 | 既知の脆弱性悪用 | 定期的な npm audit、依存関係の最小化 |
| W-04 | 不適切なエラーメッセージ | システム情報漏洩 | 本番環境でのエラー詳細非表示 |

### 1.4 運用

| ID | リスク | 影響 | 対策 |
|----|-------|------|------|
| O-01 | 講師の端末紛失・盗難 | データ漏洩 | 暗号化保存、リモートワイプ推奨 |
| O-02 | 講師間でのデータ不正共有 | プライバシー侵害 | 担当生徒以外のアクセス制限（将来） |
| O-03 | 退職講師のデータ残存 | 不正アクセス | 引き継ぎ後のデータ削除手順明確化 |
| O-04 | 保護者レポートの誤送信 | 情報漏洩 | 送信前確認画面、送信先の明示 |

---

## 2. セキュリティ実装原則

### データ保護

| 原則 | 実装指針 |
|------|---------|
| 最小権限 | 生徒の氏名・住所等は本ツールでは一切扱わない |
| データの暗号化 | LocalStorage保存時はAES-256で暗号化。鍵はユーザーのパスワードから派生 |
| センシティブデータの分離 | コンテキスト情報は通常データと分離して保存 |
| 明示的な削除 | 生徒削除時は全データ（履歴、コンテキスト含む）を完全削除 |

### AI補完のセキュリティ

| 原則 | 実装指針 |
|------|---------|
| ローカルファースト | AI処理は可能な限りブラウザ内で実行 |
| 匿名化必須 | 外部AIに送信する場合、識別子を完全除去 |
| 送信内容の明示 | 外部送信時はユーザーに内容を表示し同意を取得 |
| ローカルモデル優先 | WebLLM等のブラウザ内AI活用を検討（Phase 3以降） |

### 入力検証

| 対象 | 実装指針 |
|------|---------|
| 全ユーザー入力 | ホワイトリスト方式、HTMLタグ除去 |
| JSONインポート | スキーマ検証必須、不正データ構造は拒否 |
| コメント・メモ欄 | 長さ制限、特殊文字のエスケープ |
| 数値入力 | 型チェックと範囲チェック |

---

## 3. AIコード生成時セキュリティテンプレート

コード生成を依頼する際、以下の要件を必ず遵守すること:

1. ユーザー入力は必ずサニタイズしてから使用すること
2. LocalStorageへの保存は暗号化関数を経由すること
3. 外部APIへのデータ送信は禁止（明示的に許可された場合を除く）
4. エラーメッセージにシステム内部情報を含めないこと
5. 依存ライブラリは最小限に、既知の脆弱性がないことを確認
6. `dangerouslySetInnerHTML` 等の危険なAPIは使用禁止
